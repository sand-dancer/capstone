version: 2.1

jobs:
  test:
    docker:
      - image: python:3.7.3-stretch
    steps:
      - checkout
      - run:
          name: Test the dockerfile
          command: make test

  build:
    docker:
      - image: cimg/base:2022.06
        auth:
          username: $DOCKER_USERNAME
          password: $DOCKERHUB_ACCESS_CODE  # context / project UI env-var reference
    steps:
      - checkout
      - run:
          name: Build and push the dockerfile
          command: make build-image

  create-cluster:
    docker:
      - image: amazon/aws-cli
    steps:
      - run:
          name: Create a small 2 node cluster
          command: |
            make create-cluster

  deploy-to-cluster:
    docker:
     - image: amazon/aws-cli
    steps:
      - run:
          name: Deploy the docker file to the cluster
          command: |
            make deploy-to-cluster

workflows:
  default:
    jobs:
      - test
      - build
